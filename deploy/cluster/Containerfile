# ---------- Frontend Build ----------
FROM registry.access.redhat.com/ubi9/nodejs-22 AS frontend-builder

USER root

WORKDIR /app/frontend

# Copy pre-built frontend assets (built locally to avoid cross-compilation issues)
COPY frontend/dist ./dist


# ---------- Backend Build ----------
FROM registry.access.redhat.com/ubi9/python-312:latest

USER root
# Set working directory
WORKDIR /app

# Install ffmpeg from RPM Fusion or compile from source
RUN dnf install -y nmap-ncat wget tar && \
    # Try to install ffmpeg from static builds
    wget -q https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz -O /tmp/ffmpeg.tar.xz && \
    cd /tmp && tar -xf ffmpeg.tar.xz && \
    find . -name "ffmpeg" -type f -executable -exec cp {} /usr/local/bin/ \; && \
    chmod +x /usr/local/bin/ffmpeg && \
    rm -rf /tmp/ffmpeg* && \
    dnf clean all

# Copy backend and install dependencies
COPY backend/ ./backend/
COPY frontend/src/assets/ ./backend/public/assets
COPY deploy/cluster/scripts/entrypoint.sh ./entrypoint.sh
COPY backend/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy built frontend to backend's static files
COPY --from=frontend-builder /app/frontend/dist ./backend/public/


USER 1001
# Expose FastAPI port
EXPOSE 8000

# Start FastAPI server
CMD ["./entrypoint.sh"]
