FROM registry.access.redhat.com/ubi9/python-312:latest

USER root

# Install only essential runtime dependencies
RUN dnf install -y nmap-ncat && \
    dnf clean all && \
    rm -rf /var/cache/dnf

# Set working directory
WORKDIR /app

# Switch to non-root user (UBI images use 1001 by default)
USER 1001

# Configure pip for better performance
RUN pip install --upgrade pip && \
    pip config set global.disable-pip-version-check true

# Copy requirements first for better layer caching
COPY backend/requirements.txt .

# Install Python dependencies with optimizations
RUN pip install --prefer-binary --no-cache-dir -r requirements.txt

# Copy backend code (excluding __pycache__ via .dockerignore)
COPY backend/ ./backend/

# Set Python path
ENV PYTHONPATH=/app

# Copy startup script and make executable in one layer
COPY deploy/local/scripts/start-backend-dev.sh /app/start-backend-dev.sh

# Expose the port
EXPOSE 8000

# Start the development server with auto-migrations
CMD ["/app/start-backend-dev.sh"]
