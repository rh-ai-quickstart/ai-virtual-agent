FROM registry.access.redhat.com/ubi9/python-312:latest

USER root

# UBI9 ships SQLite 3.34.1 but ChromaDB (via CrewAI) requires >= 3.35.0.
# Compile a newer SQLite so Python's built-in sqlite3 module picks it up.
RUN dnf install -y gcc make wget sqlite-devel && \
    wget -q https://www.sqlite.org/2024/sqlite-autoconf-3450000.tar.gz && \
    tar xzf sqlite-autoconf-3450000.tar.gz && \
    cd sqlite-autoconf-3450000 && \
    ./configure --prefix=/usr/local && \
    make -j"$(nproc)" && make install && \
    cd / && rm -rf sqlite-autoconf-* && \
    dnf remove -y gcc make wget && dnf clean all

ENV LD_LIBRARY_PATH=/usr/local/lib:${LD_LIBRARY_PATH}

# Set working directory
WORKDIR /app

# Configure pip for better performance
RUN pip install --upgrade pip && \
    pip config set global.disable-pip-version-check true

# Copy requirements first for better layer caching
COPY backend/requirements.txt .

# Install Python dependencies with optimizations
RUN pip install --prefer-binary --no-cache-dir -r requirements.txt

# Install coverage for integration test coverage collection
RUN pip install --prefer-binary --no-cache-dir 'coverage[toml]>=7.0.0'

# Copy coverage configuration from project root
COPY .coveragerc /app/.coveragerc

# Note: backend code will be mounted via volume in compose.yaml
# No need to COPY it here for dev environment

# Set Python path
ENV PYTHONPATH=/app

# Copy startup script and make executable
COPY deploy/local/scripts/start-backend-dev.sh /app/start-backend-dev.sh
RUN chmod +x /app/start-backend-dev.sh

# Expose the port
EXPOSE 8000

# Start the development server with auto-migrations
CMD ["/app/start-backend-dev.sh"]
